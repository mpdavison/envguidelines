# Guidelinely R Package - AI Coding Assistant Instructions

## Project Overview

This is an R package providing programmatic access to the Guidelinely API (https://guidelines.1681248.com/docs), an **environmental guideline calculation and search API**.

**Purpose**: Calculate environmental guideline values for chemical parameters in various media (water, soil, sediment) based on environmental context (pH, hardness, temperature, etc.).

## Development Setup

This project runs in an RStudio dev container on Ubuntu 24.04.2 LTS.

## API Integration Guidelines

**API Documentation**: https://guidelines.1681248.com/docs (Swagger UI)  
**OpenAPI Spec**: https://guidelines.1681248.com/openapi.json

### Key API Characteristics

- **No authentication required** for main endpoints (metadata, calculation)
- **Returns JSON** with consistent structure: `{results: [...], context: {...}, total_count: N}`
- **Environmental context matters**: calculations depend on pH, hardness, temperature, etc.
- **Unit ranges**: Values returned in PostgreSQL `unitrange` format: `[10 μg/L,100 μg/L]`

### Main Endpoint Groups

**Health Endpoints** (GET, no auth):
- `/api/v1/health` - Lightweight health check (returns 200 if service is running)
- `/api/v1/ready` - Readiness check with database connectivity

**Metadata Endpoints** (GET, no auth):
- `/api/v1/parameters` - List all chemical parameters
- `/api/v1/parameters/search?q=...` - Search parameters by substring (optionally filter by media)
- `/api/v1/media` - List environmental media types (surface_water, soil, sediment, air, etc.)
- `/api/v1/sources` - List guideline sources and documents
- `/api/v1/stats` - Database statistics

**Calculation Endpoints** (POST, optional API key):
- `/api/v1/calculate` - Calculate guidelines for single parameter
- `/api/v1/calculate/batch` - Calculate for multiple parameters (max 50)

**Request Body Pattern for Calculations**:
```json
{
  "parameter": "Aluminum",
  "media": "surface_water",
  "context": {
    "pH": 7.0,
    "hardness": 100
  },
  "target_unit": "μg/L"
}
```

### Implementation Requirements

- Use `httr2` for all HTTP requests
- Store API base URL: `GUIDELINELY_API_BASE <- "https://guidelines.1681248.com/api/v1"`
- **No authentication needed** for main endpoints
- Use `simplifyVector = TRUE` in `resp_body_json()` to convert JSON arrays/objects to R structures
- Handle errors gracefully with `req_error(body = ...)` to extract API error messages
- Use `req_body_json(auto_unbox = TRUE)` for batch calculations to properly serialize mixed lists

### Environmental Context Patterns

Context parameters are **strings with units** (using Pint unit format):

**Water (surface_water, groundwater)**:
```r
context = list(
  pH = "7.0 1",              # Dimensionless (use "1" as unit)
  hardness = "100 mg/L",     # mg/L as CaCO3
  temperature = "20 °C",     # Degrees Celsius
  chloride = "50 mg/L"       # mg/L
)
```

**Soil**:
```r
context = list(
  pH = "6.5 1",                                # Dimensionless
  organic_matter = "3.5 %",                    # Percent
  cation_exchange_capacity = "15 meq/100g"     # meq per 100g
)
```

### API Function Pattern

```r
#' Calculate guidelines for a parameter
#' @param parameter Chemical parameter name
#' @param media Media type (surface_water, soil, etc.)
#' @param context Named list of environmental parameters (numeric values)
#' @return List with results, context, total_count
#' @export
calculate_guidelines <- function(parameter, media, context = NULL) {
  body <- list(parameter = parameter, media = media)
  if (!is.null(context)) body$context <- context
  
  httr2::request(paste0(GUIDELINELY_API_BASE, "/calculate")) |>
    httr2::req_body_json(body) |>
    httr2::req_error(body = function(resp) {
      msg <- httr2::resp_body_json(resp)$message
      if (!is.null(msg)) msg else "API request failed"
    }) |>
    httr2::req_perform() |>
    httr2::resp_body_json(simplifyVector = TRUE)
}
```

## R Package Conventions

- Function names: `snake_case`
- Export public API functions with `#' @export` roxygen tags
- Keep internal helpers unexported
- Use `usethis::use_package()` to add dependencies to DESCRIPTION
- Document all exported functions with roxygen2 comments
- Write tests in `tests/testthat/` using pattern `test-<function-name>.R`

## Testing Strategy

- Use `testthat` for unit tests
- Mock API calls with `httptest2` (integrates well with `httr2`)
- Test both `/api/v1/metadata` and `/api/v1/guidelines` endpoints
- Test error handling for: missing API key, 401, 404, 500, rate limits
- Verify functions return tibbles compatible with `dplyr` operations

## Dependencies

Add to DESCRIPTION:
- `httr2` - HTTP client
- `tibble` - Return data as tibbles
- `rlang` - For `%||%` operator in API key handling

Suggested imports: `dplyr`, `purrr` for internal data manipulation

## Key Files to Create

- `DESCRIPTION` - package metadata with `httr2`, `tibble`, `rlang` dependencies
- `NAMESPACE` - auto-generated by roxygen2
- `R/api-client.R` - Core API client functions (metadata, guidelines)
- `R/auth.R` - API key management helpers
- `R/utils.R` - Internal utilities
- `man/` - auto-generated documentation
- `tests/testthat/` - test files with mocked API responses
- `vignettes/getting-started.Rmd` - usage examples with both endpoints
